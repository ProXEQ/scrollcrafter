{
  "version": 3,
  "sources": ["../../src/extractors/auditStrings.ts"],
  "sourcesContent": ["import { unlinkSync, writeFileSync } from \"node:fs\";\r\nimport path from \"node:path\";\r\nimport type { Block, SetOfBlocks } from \"gettext-merger\";\r\nimport type { Args } from \"../types.js\";\r\n\r\nexport function audit(args: Args, translationsUnion: SetOfBlocks) {\r\n\t/** Run the audit process */\r\n\tconst auditor = new StringAuditor(args.domain);\r\n\tauditor.auditStrings(translationsUnion.blocks);\r\n\r\n\t/** Get and print the results of the audit process */\r\n\tconsole.log(\"\\nAudit Complete!\");\r\n\tif (auditor.getResults().length === 0) {\r\n\t\tconsole.log(\"No issues found! \uD83C\uDF89\");\r\n\t\t//if there are no errors, we can remove the audit.log file\r\n\t\ttry {\r\n\t\t\tunlinkSync(path.join(args.paths.cwd, \"audit.log\"));\r\n\t\t} catch (error) {\r\n\t\t\t//ignore\r\n\t\t}\r\n\t} else {\r\n\t\tconsole.log(`Found ${auditor.getResults().length} issues!`);\r\n\t\tconst results = auditor.getResults().join(\"\\n\");\r\n\t\tconsole.log(results);\r\n\t\t/** Write the audit results to a file */\r\n\t\twriteFileSync(path.join(args.paths.cwd, \"audit.log\"), results);\r\n\t}\r\n}\r\n\r\n/**\r\n * Class to audit gettext strings\r\n *\r\n * Example usage:\r\n * const auditor = new StringAuditor('plugin');\r\n * auditor.auditStrings(translationBlocks);\r\n */\r\nclass StringAuditor {\r\n\tprivate readonly SPRINTF_PLACEHOLDER_REGEX =\r\n\t\t/%(?:\\d+\\$)?[+-]?(?:[ 0]|'.)?-?\\d*(?:\\.\\d+)?[bcdeEfFgGhHosuxX]/g;\r\n\tprivate readonly UNORDERED_SPRINTF_PLACEHOLDER_REGEX =\r\n\t\t/%(?!(\\d+)\\$)[+-]?(?:[ 0]|'.)?-?\\d*(?:\\.\\d+)?[bcdeEfFgGhHosuxX]/g;\r\n\tprivate projectType: string;\r\n\r\n\t/**\r\n\t * The results of the audit process\r\n\t */\r\n\tpublic results: string[] = [];\r\n\r\n\tconstructor(projectType: string) {\r\n\t\tthis.projectType = projectType;\r\n\t}\r\n\r\n\tprivate getFileHeaders(projectType: string): string[] {\r\n\t\t// Implement based on your requirements\r\n\t\t// This would be the equivalent of the PHP get_file_headers method\r\n\t\tconst headers: Record<string, string[]> = {\r\n\t\t\tplugin: [\r\n\t\t\t\t\"Plugin Name:\",\r\n\t\t\t\t\"Plugin URI:\",\r\n\t\t\t\t\"Description:\",\r\n\t\t\t\t\"Author:\",\r\n\t\t\t\t\"Author URI:\",\r\n\t\t\t\t\"Version:\",\r\n\t\t\t\t\"Text Domain:\",\r\n\t\t\t\t\"Domain Path:\",\r\n\t\t\t\t\"Network:\",\r\n\t\t\t\t\"Requires at least:\",\r\n\t\t\t\t\"Requires PHP:\",\r\n\t\t\t],\r\n\t\t\ttheme: [\r\n\t\t\t\t\"Theme Name:\",\r\n\t\t\t\t\"Theme URI:\",\r\n\t\t\t\t\"Author:\",\r\n\t\t\t\t\"Author URI:\",\r\n\t\t\t\t\"Description:\",\r\n\t\t\t\t\"Version:\",\r\n\t\t\t\t\"License:\",\r\n\t\t\t\t\"License URI:\",\r\n\t\t\t\t\"Text Domain:\",\r\n\t\t\t\t\"Domain Path:\",\r\n\t\t\t\t\"Tags:\",\r\n\t\t\t\t\"Requires at least:\",\r\n\t\t\t\t\"Requires PHP:\",\r\n\t\t\t],\r\n\t\t};\r\n\r\n\t\treturn headers[projectType] || [];\r\n\t}\r\n\r\n\tauditStrings(translations: Block[]): void {\r\n\t\tfor (const translation of translations) {\r\n\t\t\tconst references = translation.comments?.reference || [];\r\n\r\n\t\t\t// File headers don't have any file references\r\n\t\t\tconst location = references.length > 0 ? `(${references[0]})` : \"\";\r\n\r\n\t\t\t// Check 0: Flag strings without msgid is the header so it's not a translation and should be ignored\r\n\t\t\tif (!translation.msgid) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\t// Check 1: Flag strings with placeholders that should have translator comments\r\n\t\t\tif (\r\n\t\t\t\t(!translation.comments?.extracted ||\r\n\t\t\t\t\ttranslation.comments.extracted.length === 0) &&\r\n\t\t\t\t(translation.msgid.match(this.SPRINTF_PLACEHOLDER_REGEX) || [])\r\n\t\t\t\t\t.length >= 1\r\n\t\t\t) {\r\n\t\t\t\tconst message = `The string \"${translation.msgid}\" contains placeholders but has no \"translators:\" comment to clarify their meaning. ${location}`;\r\n\t\t\t\tthis.results.push(message);\r\n\t\t\t}\r\n\r\n\t\t\t// Check 2: Flag strings with different translator comments\r\n\t\t\tif (\r\n\t\t\t\ttranslation.comments?.extracted &&\r\n\t\t\t\ttranslation.comments.extracted.length > 0\r\n\t\t\t) {\r\n\t\t\t\tlet comments = translation.comments.extracted;\r\n\r\n\t\t\t\t// Remove plugin header information from comments\r\n\t\t\t\tcomments = comments.filter((comment) => {\r\n\t\t\t\t\tfor (const fileHeader of this.getFileHeaders(this.projectType)) {\r\n\t\t\t\t\t\tif (comment.startsWith(fileHeader)) {\r\n\t\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t});\r\n\r\n\t\t\t\tconst uniqueComments: string[] = [];\r\n\r\n\t\t\t\t// Remove duplicate comments\r\n\t\t\t\tcomments = comments.filter((comment) => {\r\n\t\t\t\t\tif (uniqueComments.includes(comment)) {\r\n\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tuniqueComments.push(comment);\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t});\r\n\r\n\t\t\t\tconst commentsCount = comments.length;\r\n\r\n\t\t\t\tif (commentsCount > 1) {\r\n\t\t\t\t\tconst message = `The string \"${translation.msgid}\" has ${commentsCount} different translator comments. ${location}\\n${comments.join(\"\\n\")}`;\r\n\t\t\t\t\tthis.results.push(message);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Extract non-placeholder content from the string\r\n\t\t\tconst nonPlaceholderContent = translation.msgid\r\n\t\t\t\t.trim()\r\n\t\t\t\t.replace(/^(['\"])(.*)\\1$/s, \"$2\")\r\n\t\t\t\t.replace(this.SPRINTF_PLACEHOLDER_REGEX, \"\");\r\n\r\n\t\t\t// Check 3: Flag empty strings without any translatable content\r\n\t\t\tif (nonPlaceholderContent === \"\") {\r\n\t\t\t\tconst message = `Found string without translatable content. ${location}`;\r\n\t\t\t\tthis.results.push(message);\r\n\t\t\t}\r\n\r\n\t\t\t// Check 4: Flag strings with multiple unordered placeholders (%s %s %s vs. %1$s %2$s %3$s)\r\n\t\t\tconst unorderedMatches =\r\n\t\t\t\ttranslation.msgid.match(this.UNORDERED_SPRINTF_PLACEHOLDER_REGEX) || [];\r\n\t\t\tconst unorderedMatchesCount = unorderedMatches.length;\r\n\r\n\t\t\tif (unorderedMatchesCount >= 2) {\r\n\t\t\t\tconst message = `Multiple placeholders should be ordered. ${location}`;\r\n\t\t\t\tthis.results.push(message);\r\n\t\t\t}\r\n\r\n\t\t\tif (translation.msgid_plural) {\r\n\t\t\t\tconst singlePlaceholders =\r\n\t\t\t\t\ttranslation.msgid.match(this.SPRINTF_PLACEHOLDER_REGEX) || [];\r\n\t\t\t\tconst pluralPlaceholders =\r\n\t\t\t\t\ttranslation.msgid_plural.match(this.SPRINTF_PLACEHOLDER_REGEX) || [];\r\n\r\n\t\t\t\t// See https://developer.wordpress.org/plugins/internationalization/how-to-internationalize-your-plugin/#plurals\r\n\t\t\t\tif (singlePlaceholders.length < pluralPlaceholders.length) {\r\n\t\t\t\t\t// Check 5: Flag things like _n('One comment', '%s Comments')\r\n\t\t\t\t\tconst message = `Missing singular placeholder, needed for some languages. See https://developer.wordpress.org/plugins/internationalization/how-to-internationalize-your-plugin/#plurals ${location}`;\r\n\t\t\t\t\tthis.results.push(message);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Reordering is fine, but mismatched placeholders is probably wrong\r\n\t\t\t\t\tconst sortedSinglePlaceholders = [...singlePlaceholders].sort();\r\n\t\t\t\t\tconst sortedPluralPlaceholders = [...pluralPlaceholders].sort();\r\n\r\n\t\t\t\t\t// Check 6: Flag things like _n('%s Comment (%d)', '%s Comments (%s)')\r\n\t\t\t\t\tif (\r\n\t\t\t\t\t\tJSON.stringify(sortedSinglePlaceholders) !==\r\n\t\t\t\t\t\tJSON.stringify(sortedPluralPlaceholders)\r\n\t\t\t\t\t) {\r\n\t\t\t\t\t\tconst message = `Mismatched placeholders for singular and plural string. ${location}`;\r\n\t\t\t\t\t\tthis.results.push(message);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Get the results of the audit process\r\n\t * @returns An array of messages\r\n\t */\r\n\tpublic getResults(): string[] {\r\n\t\treturn this.results;\r\n\t}\r\n}\r\n\r\nexport default StringAuditor;\r\n"],
  "mappings": "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",
  "names": ["path"]
}
